(function(d){var b=null;var e=function(){};var a=function(){};var g=function(){};var f=function(){};var c=function(){};e.prototype={containerId:"#box-canvas",wrapperId:"box-canvas-wrapper",canvasId:"c1",canvas:null,canvasScale:0,width:780,height:780,left:0,top:0,grid:{lines:null,size:20,visible:false,close:false},crop:{on:false,select:false,disable:false,selector:null,mousex:0,mousey:0},undo:{on:false,current:null,prev:null,stack:[],index:0,history:10},base:{id:0},backgroundColor:"white",defaultText:null,mousex:0,mousey:0,selected:false,activex:0,activey:0,sender:null,init:null,position:null,inEl:null,generateId:null,tools:null,texteditor:null,imageeditor:null,draweditor:null};a.prototype={containerId:".tools",container:null,init:null,newcanvas:null,remove:null,group:null,backward:null,forward:null,toBack:null,toFront:null,flip:null,addtext:null,addpic:null,addpic_callback:null,addgrid:null,backgroundcolor:null,overlayimage:null,move_callback:null,zoom:null,preview:null,preview_callback:null,save:null,save_callback:null,reload:null};g.prototype={containerId:".text-editor",id:null,current:null,container:null,init:null,fill:null,changeFontFamily:null,changeText:null,changeFontProperty:null,textselected:null,textselected_callback:null};f.prototype={containerId:".image-editor",id:null,current:null,zoomValue:null,rotateValue:null,container:null,init:null,zoom:null,rotate:null,flipX:null,flipY:null,imageselected:null};c.prototype={containerId:".draw-editor",id:null,current:null,lineWidth:null,shadowWidth:null,container:null,init:null,fill:null,enable:null};e.prototype.tools=new a();e.prototype.texteditor=new g();e.prototype.imageeditor=new f();e.prototype.draweditor=new c();e.prototype.defaultText={text:"Your Text Is Here",property:{fontFamily:"Arial",fontSize:30,fill:"black"}};e.prototype.init=function(k,h,j){this.canvasId=k;this.canvasScale=j;this.canvas=b=new fabric.Canvas(this.canvasId);console.log(fabric);this.width=b.getWidth();this.height=b.getHeight();b.backgroundColor=this.backgroundColor=h;b.clear();this.update()};e.prototype.position=function(h){var k=null;k=[0,0];var j=h.getBoundingClientRect();return j};e.prototype.update=function(){var h=this.position(document.getElementById(this.wrapperId));this.left=h.left;this.top=h.top};e.prototype.inEl=function(k){if(k===undefined||k===null){return false}var m=k.left-k.getBoundingRectWidth()/2+this.left;var l=k.top-k.getBoundingRectHeight()/2+this.top;var j=m+k.getBoundingRectWidth();var h=l+k.getBoundingRectHeight();if(this.mousex>m&&this.mousex<j){if(this.mousey>l&&this.mousey<h){return true}}return false};e.prototype.generateId=function(){return this.base.id++};a.prototype.init=function(){this.container=d.mememaker;this.selected();this.addgrid()};a.prototype.newcanvas=function(h){b.backgroundColor=this.backgroundColor=h;b.clear()};a.prototype.exist=function(){var h=b.getActiveObject();if(h===undefined||h===null){h=b.getActiveGroup();if(h===undefined||h===null){return false}}return true};a.prototype.remove=function(){var h=b.getActiveObject();if(h===undefined||h===null){h=b.getActiveGroup();if(h===undefined||h===null){return false}b.discardActiveGroup();for(i=0;i<h.getObjects().length;++i){b.remove(h.item(i))}return h.type}b.remove(h);return h.type};a.prototype.group=function(){var l=b.getActiveGroup();if(l===undefined||l===null){return}var m=[];var j=[];var k=0;for(k=0;k<l.getObjects().length;++k){if(l.item(k).isType("image")){m[k]=null}else{m[k]=l.item(k).clone()}}for(k=0;k<l.getObjects().length;++k){if(l.item(k).isType("image")){j[k]=l.item(k)}else{j[k]=null}}function h(q,o,n,p){if(q>=n.length){var r=new fabric.Group(o,{left:p.left,top:p.top});b.discardActiveGroup();for(k=0;k<o.length;++k){b.remove(p.item(k))}b.add(r);return}if(n[q]!==null){n[q].clone(function(s){o[q]=s;h(q+1,o,n,p)},null)}else{h(q+1,o,n,p)}}h(0,m,j,l)};a.prototype.move=function(j){if(j===undefined||j===null){return}var h=b.getActiveObject();if(h===undefined||h===null){h=b.getActiveGroup();if(h===undefined||h===null){return}}if(j=="moveleft"){h.left--}if(j=="moveright"){h.left++}if(j=="moveup"){h.top--}if(j=="movedown"){h.top++}b.renderAll()};a.prototype.lock=function(){var h=b.getActiveObject();if(h===undefined||h===null){h=b.getActiveGroup();if(h===undefined||h===null){return false}}h.lockMovementX=h.lockMovementX===false?true:false;h.lockMovementY=h.lockMovementY===false?true:false;b.renderAll();return h.lockMovementX};a.prototype.backward=function(){var h=b.getActiveObject();if(h===undefined||h===null){h=b.getActiveGroup();if(h===undefined||h===null){return}}h.sendBackwards();b.renderAll()};a.prototype.forward=function(){var h=b.getActiveObject();if(h===undefined||h===null){h=b.getActiveGroup();if(h===undefined||h===null){return}}h.bringForward()};a.prototype.toBack=function(){var h=b.getActiveObject();if(h===undefined||h===null){h=b.getActiveGroup();if(h===undefined||h===null){return}}h.sendToBack()};a.prototype.toFront=function(){var h=b.getActiveObject();if(h===undefined||h===null){h=b.getActiveGroup();if(h===undefined||h===null){return}}h.bringToFront()};a.prototype.flip=function(h){var j=b.getActiveObject();if(j===undefined||j===null){j=b.getActiveGroup();if(j===undefined||j===null){return}}if(h===0){j.flipX=j.flipX===true?false:true}else{j.flipY=j.flipY===true?false:true}b.renderAll()};a.prototype.addtext=function(){var h=new fabric.Text(d.mememaker.defaultText.text,d.mememaker.defaultText.property);h.text="CLICK TO EDIT";h.left=b.width/2;h.top=b.height/2;b.add(h);h.selectable=true;h.setCoords();h.id=d.mememaker.generateId();b.renderAll()};a.prototype.addpic=function(h){fabric.Image.fromURL(h,function(j){j.id=d.mememaker.generateId();j.padding=10;j.left=b.width*1/3;j.top=b.height*1/3;j.scaleToWidth(Math.ceil(b.getWidth()*2/3));b.add(j);b.renderAll();d.mememaker.tools.addpic_callback();console.log(j)})};a.prototype.undo=function(){d.mememaker.undo.on=true;d.mememaker.undo.stack=JSON.parse(localStorage.state);if(d.mememaker.undo.index<=0){d.mememaker.undo.on=false;return}console.log(d.mememaker.undo.stack);d.mememaker.undo.index--;var h=d.mememaker.undo.stack[d.mememaker.undo.index];if(h.type=="text"){console.log("currentId="+d.mememaker.undo.current.id);console.log("objectId="+h.id);console.log("index="+d.mememaker.undo.index);if(d.mememaker.undo.current.id==h.id){d.mememaker.undo.current.remove()}else{var j=b.getObjects();for(i in j){if(j[i].id==h.id){j[i].remove()}}}var k=new fabric.Text.fromObject(h);b.add(k);b.renderAll();d.mememaker.undo.on=false;d.mememaker.undo.current=k;localStorage.state=JSON.stringify(d.mememaker.undo.stack)}if(h.type=="image"){fabric.Image.fromObject(h,function(l){if(d.mememaker.undo.current.id==h.id){d.mememaker.undo.current.remove()}else{var m=b.getObjects();for(i in m){if(m[i].id==h.id){m[i].remove()}}}b.add(l);b.renderAll();d.mememaker.undo.on=false;d.mememaker.undo.current=l;localStorage.state=JSON.stringify(d.mememaker.undo.stack)})}};a.prototype.redo=function(){d.mememaker.undo.on=true;d.mememaker.undo.stack=JSON.parse(localStorage.state);if(d.mememaker.undo.index>=d.mememaker.undo.history){d.mememaker.undo.on=false;return}console.log(d.mememaker.undo.stack);d.mememaker.undo.index++;var h=d.mememaker.undo.stack[d.mememaker.undo.index];if(h.type=="text"){console.log("currentId="+d.mememaker.undo.current.id);console.log("objectId="+h.id);console.log("index="+d.mememaker.undo.index);if(d.mememaker.undo.current.id==h.id){d.mememaker.undo.current.remove()}else{var j=b.getObjects();for(i in j){if(j[i].id==h.id){j[i].remove()}}}var k=new fabric.Text.fromObject(h);b.add(k);b.renderAll();d.mememaker.undo.on=false;d.mememaker.undo.current=k;localStorage.state=JSON.stringify(d.mememaker.undo.stack)}if(h.type=="image"){fabric.Image.fromObject(h,function(l){if(d.mememaker.undo.current.id==h.id){d.mememaker.undo.current.remove()}else{var m=b.getObjects();for(i in m){if(m[i].id==h.id){m[i].remove()}}}b.add(l);b.renderAll();d.mememaker.undo.on=false;d.mememaker.undo.current=l;localStorage.state=JSON.stringify(d.mememaker.undo.stack)})}};a.prototype.selected=function(){b.on("object:selected",function(j){var h=j.target;if(h.type=="text"){console.log(h.type);d.mememaker.selected=true;d.mememaker.activex=h.left;d.mememaker.activey=h.top;d.mememaker.texteditor.textselected()}if(h.type=="image"){d.mememaker.selected=true;d.mememaker.activex=h.left;d.mememaker.activey=h.top;d.mememaker.imageeditor.imageselected()}});b.on("object:added",function(h){});b.on("object:modified",function(j){console.log("before:modified");if(d.mememaker.undo.on){return}console.log("modifed");var h=j.target.toJSON(["id"]);d.mememaker.undo.stack=JSON.parse(localStorage.state);d.mememaker.undo.index=d.mememaker.undo.stack.length-1;if(d.mememaker.undo.index<0){d.mememaker.undo.index=0}d.mememaker.undo.stack.push(h);d.mememaker.undo.index++;if(d.mememaker.undo.index>=d.mememaker.undo.history){d.mememaker.undo.stack=d.mememaker.undo.stack.slice(1,d.mememaker.undo.hisory-1)}console.log(d.mememaker.undo.stack);localStorage.state=JSON.stringify(d.mememaker.undo.stack);d.mememaker.undo.current=j.target;d.mememaker.undo.stack=null});b.on("object:removed",function(h){})};a.prototype.addshape=function(j){if(j===undefined||j===null){return}var h;if(j=="circle"){h=new fabric.Circle({radius:Math.ceil(b.width*2/5/2),fill:"green"})}if(j=="rect"){h=new fabric.Rect({fill:"#ccc",width:Math.ceil(b.width*2/5),height:Math.ceil(b.width*2/5)})}if(j=="tri"){h=new fabric.Triangle({width:Math.ceil(b.width*2/5),height:Math.ceil(b.width*2/5),fill:"blue"})}h.left=b.width/2;h.top=b.width/2;b.add(h)};a.prototype.addgrid=function(){var p=b.width;var h=b.height;var l=[];var m=0;var k=null;var q=[];var o=this.container.grid.size;for(m=0;m<4;++m){p*=1.2;h*=1.2}m=0;for(var n=0;n<Math.ceil(p/20);++n){q[0]=n*o;q[1]=0;q[2]=n*o;q[3]=h;k=null;k=new fabric.Line(q,{stroke:"#999",opacity:0.5});k.selectable=false;k.visible=false;b.add(k);k.sendToBack();l[m]=k;m+=1}for(n=0;n<Math.ceil(h/20);++n){q[0]=0;q[1]=n*o;q[2]=p;q[3]=n*o;k=null;k=new fabric.Line(q,{stroke:"#999",opacity:0.5});k.selectable=false;k.visible=false;b.add(k);k.sendToBack();l[m]=k;m+=1}this.container.grid.lines=l;b.renderAll()};a.prototype.showgrid=function(){if(this.container.grid.lines===null){return false}console.log(this.container.grid.lines);this.container.grid.visible=!this.container.grid.visible;for(i in this.container.grid.lines){this.container.grid.lines[i].visible=!this.container.grid.lines[i].visible}b.renderAll();return true};a.prototype.closegrid=function(){if(this.container.grid.close){this.showgrid();this.container.grid.close=false;return}if(this.container.grid.visible===false){return}this.showgrid();this.container.grid.close=true};a.prototype.backgroundcolor=function(h){this.container.backgroundColor=h;b.backgroundColor=h;b.renderAll()};a.prototype.backgroundimage=function(h){b.setBackgroundImage(h,function(){b.renderAll()},{originX:"left",originY:"top",left:0,top:0})};a.prototype.overlayimage=function(h){b.setOverlayImage(h,b.renderAll.bind(b))};a.prototype.zoom=function(j){var m=j/b.getWidth();height=m*b.getHeight();b.setDimensions({width:j,height:height});b.calcOffset();var t=b.getObjects();for(var n in t){var s=t[n].scaleX;var r=t[n].scaleY;var k=t[n].left;var q=t[n].top;var p=s*m;var o=r*m;var l=k*m;var h=q*m;if(t[n].type=="line"&&t[n].selectable===false&&t[n].get("opacity")===0.5){continue}t[n].scaleX=p;t[n].scaleY=o;t[n].left=l;t[n].top=h;t[n].setCoords()}b.renderAll();this.container.update()};a.prototype.zoomreset=function(){var l=this.container.width/b.getWidth();b.setDimensions({width:d.mememaker.width,height:d.mememaker.height});var s=b.getObjects();for(var m in s){var r=s[m].scaleX;var q=s[m].scaleY;var j=s[m].left;var p=s[m].top;var o=r*l;var n=q*l;var k=j*l;var h=p*l;if(s[m].type=="line"&&s[m].selectable===false&&s[m].get("opacity")===0.5){continue}s[m].scaleX=o;s[m].scaleY=n;s[m].left=k;s[m].top=h;s[m].setCoords()}b.renderAll();this.container.update()};a.prototype.preview=function(){this.closegrid();b.deactivateAll();var h=b.toDataURL({format:"jpeg",quality:1});this.closegrid();if(this.preview_callback!==null){this.preview_callback(h)}};a.prototype.save=function(){this.zoomreset();var h=JSON.stringify(b.toJSON());this.save_callback(h)};a.prototype.reload=function(h){this.zoomreset();b.clear();b.loadFromJSON(h);b.renderAll();b.calcOffset()};g.prototype.fill=function(h){var j=b.getActiveObject();if(j===undefined||j===null){return}if(j.type!="text"){return}j.fill=h;b.renderAll()};g.prototype.changeFontFamily=function(h){var j=b.getActiveObject();if(j===undefined||j===null){return}if(j.type!="text"){return}j.fontFamily=h;b.renderAll()};g.prototype.changeText=function(j){var h=b.getActiveObject();if(h===undefined||h===null){return}if(h.type!="text"){return}h.text=j;if(h.text===""){b.remove(h)}b.renderAll()};g.prototype.changeFontProperty=function(j){var h=b.getActiveObject();if(h===undefined||h===null){return}if(h.type!="text"){return}console.log(h);if(j=="weight"){if(h.fontWeight=="800"){h.fontWeight="400"}else{h.fontWeight="800"}}if(j=="italic"){if(h.fontStyle=="italic"){h.fontStyle=""}else{h.fontStyle="italic"}}h.useNative=true;if(j=="underline"){if(h.textDecoration=="underline"){h.textDecoration=null}else{h.textDecoration="underline"}}b.renderAll()};g.prototype.changeFontSize=function(h){var j=b.getActiveObject();if(j===undefined||j===null){return}if(j.type!="text"){return}h=parseInt(h,10);if(h<=0){return}j.fontSize=h;b.renderAll();return};g.prototype.changeFontColor=function(h){var j=b.getActiveObject();if(j===undefined||j===null){return}if(j.type!="text"){return}j.fill=h;b.renderAll();return};g.prototype.changeFontAlign=function(j){var h=b.getActiveObject();if(h===undefined||h===null){return}if(h.type!="text"){return}h.textAlign=j;b.renderAll();return};f.prototype.init=function(){this.container=d.mememaker};f.prototype.zoom=function(j){var h=b.getActiveObject();if(h===undefined||h===null){return}if(h.type!="image"){return}var k=j/100;h.scale(k);b.renderAll()};f.prototype.rotate=function(j){var h=b.getActiveObject();if(h===undefined||h===null){return}if(h.type!="image"){return}h.originX="center";h.originY="center";h.angle=j;b.renderAll()};f.prototype.cropstart=function(){var h=b.getActiveObject();if(h===undefined||h===null){return false}if(h.type!="image"){return false}this.container.crop.on=true;this.container.crop.select=false;this.container.crop.disable=false;h.lockMovementX=h.lockMovementY=true;h.lockRotation=true;return true};f.prototype.cropselect=function(k){if(this.container.crop.on===false){return false}var h=b.getActiveObject();if(h===undefined||h===null){return false}if(h.type!="image"){return false}if(!this.container.inEl(h)){return false}console.log("crop select");if(this.container.crop.selector===null){var j=new fabric.Rect({fill:"transparent",originX:"left",originY:"top",stroke:"orangered",strokeDashArray:[2,2],opacity:1,width:1,height:1});j.visible=false;this.container.crop.selector=j;b.add(this.container.crop.selector)}this.container.crop.selector.visible=false;this.container.crop.selector.width=1;this.container.crop.selector.height=1;this.container.crop.select=true;this.container.crop.selector.left=k.pageX-d.mememaker.left;this.container.crop.selector.top=k.pageY-d.mememaker.top;this.container.crop.selector.visible=true;b.bringToFront(this.container.crop.selector);d.mememaker.crop.mousex=k.pageX;d.mememaker.crop.mousey=k.pageY;return true};f.prototype.cropunselect=function(h){if(this.container.crop.on===false){return}this.container.crop.select=false};f.prototype.cropresize=function(l){if(this.container.crop.on===false){return false}if(this.container.crop.select===false){return false}var k=b.getActiveObject();if(k===undefined||k===null){return false}if(k.type!="image"){return false}if(!this.container.inEl(k)){return false}if(this.container.crop.selector===null){return false}var j=l.pageX-d.mememaker.crop.mousex;var h=k.left+k.getBoundingRectWidth()/2;if(j>0&&j+this.container.crop.selector.left<h){this.container.crop.selector.width=l.pageX-d.mememaker.crop.mousex}j=l.pageY-d.mememaker.crop.mousey;h=k.top+k.getBoundingRectHeight()/2;if(j>0&&j+this.container.crop.selector.top<h){this.container.crop.selector.height=l.pageY-d.mememaker.crop.mousey}return true};f.prototype.cropend=function(){if(this.container.crop.on===false){return false}var l=b.getActiveObject();console.log(l);if(l===undefined||l===null){return false}if(l.type!="image"){return false}var o=this.container.crop.selector.left-l.left;var n=this.container.crop.selector.top-l.top;var k=this.container.crop.selector.width;var h=this.container.crop.selector.height;o*=1/l.scaleX;n*=1/l.scaleY;k*=1/l.scaleX;h*=1/l.scaleY;l.clipTo=function(q){q.rect(o,n,k,h)};this.container.crop.selector.visible=false;b.renderAll();var j=b.getContext("2d");var m=j.getImageData(this.container.crop.selector.left,this.container.crop.selector.top,this.container.crop.selector.width,this.container.crop.selector.height);var p=document.createElement("canvas");p.setAttribute("id","_temp_canvas");p.width=this.container.crop.selector.width;p.height=this.container.crop.selector.height;p.getContext("2d").putImageData(m,0,0);fabric.Image.fromURL(p.toDataURL(),function(q){q.left=l.left;q.top=l.top;q.padding=10;b.add(q);q.bringToFront();l.selectable=false;l.visible=false;p=null;d("#_temp_canvas").remove();b.renderAll()});this.cropcancel();return true};f.prototype.cropcancel=function(){if(this.container.crop.on===false){return}this.container.crop.on=false;this.container.crop.selector.remove();this.container.crop.selector=null;d.mememaker.tools.lock()};f.prototype.crop2=function(){fabric.Image.filters.crop2=fabric.util.createClass({type:"Redify",applyTo:function(l){var k=l.getContext("2d");var n=k.getImageData(0,0,l.width,l.height);var m=n.data;for(var j=0,h=m.length;j<h;j+=4){m[j+1]=0;m[j+2]=0}k.putImageData(n,0,0)}});fabric.Image.filters.crop2.fromObject=function(h){return new fabric.Image.filters.crop2(h)}};c.prototype.changeBrushProperty=function(h,j){switch(h){case"linewidth":b.freeDrawingBrush.width=j;break;case"shadowwidth":b.freeDrawingBrush.shadowBlur=j;break;case"color":b.freeDrawingBrush.color=j;break}};c.prototype.changeBrushType=function(k){if(k=="vline"){if(fabric.PatternBrush){var l=new fabric.PatternBrush(b);l.getPatternSrc=function(){var q=fabric.document.createElement("canvas");q.width=q.height=10;var p=q.getContext("2d");p.strokeStyle=this.color;p.lineWidth=5;p.beginPath();p.moveTo(0,5);p.lineTo(10,5);p.closePath();p.stroke();return q}}console.log(l);b.freeDrawingBrush=l}if(k=="hline"){if(fabric.PatternBrush){var m=new fabric.PatternBrush(b);m.getPatternSrc=function(){var q=fabric.document.createElement("canvas");q.width=q.height=10;var p=q.getContext("2d");p.strokeStyle=this.color;p.lineWidth=5;p.beginPath();p.moveTo(5,0);p.lineTo(5,10);p.closePath();p.stroke();return q}}b.freeDrawingBrush=m}if(k=="square"){if(fabric.PatternBrush){var j=new fabric.PatternBrush(b);j.getPatternSrc=function(){var s=10,q=2;var r=fabric.document.createElement("canvas");r.width=r.height=s+q;var p=r.getContext("2d");p.fillStyle=this.color;p.fillRect(0,0,s,s);return r}}b.freeDrawingBrush=j}if(k=="diamond"){if(fabric.PatternBrush){var o=new fabric.PatternBrush(b);o.getPatternSrc=function(){var u=10,s=5;var t=fabric.document.createElement("canvas");var r=new fabric.Rect({width:u,height:u,angle:45,fill:this.color});var p=r.getBoundingRectWidth();t.width=t.height=p+s;r.set({left:p/2,top:p/2});var q=t.getContext("2d");r.render(q);return t}}b.freeDrawingBrush=o}if(k=="texture"){if(fabric.PatternBrush){var h=new Image();h.src="img/texture/texture_honey.png";var n=new fabric.PatternBrush(b);n.source=h}b.freeDrawingBrush=n}else{b.freeDrawingBrush=new fabric[k+"Brush"](b)}if(b.freeDrawingBrush){b.freeDrawingBrush.width=this.lineWidth.getValue();b.freeDrawingBrush.shadowBlur=this.shadowWidth.getValue()}};c.prototype.enable=function(){enable=b.isDrawingMode===true?false:true;if(enable){b.discardActiveObject();b.discardActiveGroup();b.isDrawingMode=true;b.freeDrawingBrush.width=1;b.freeDrawingBrush.color="#eb34dc";d(d.mememaker.texteditor.containerId).hide(0);d(d.mememaker.imageeditor.containerId).hide(0);d(this.containerId).show(0)}else{b.discardActiveObject();b.discardActiveGroup();b.isDrawingMode=false;d(this.containerId).hide(0)}return enable};d.mememaker=new e()}(window.jQuery));